# Schema Index CI/CD Pipeline

name: CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      environment:
        type: environment
        description: Select the target environment

jobs:
  # Test Python/Django code with PostgreSQL database
  test-python:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.11

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create test environment file
      run: |
        echo "DEBUG=True" > .env
        echo "DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres" >> .env
        echo "SECRET_KEY=test-secret-key-for-ci" >> .env

    - name: Run Tests
      run: python manage.py test

  # Deploy to Google Cloud Run (staging environment)
  deploy:
    # Only deploy on push to main or manual trigger
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
        || github.event_name == 'workflow_dispatch'
    # Wait for tests to pass
    needs: [test-python]
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'Staging' }}
    env:
      DJANGO_SETTINGS_MODULE: ${{ vars.DJANGO_SETTINGS_MODULE }}
      # Temporary placeholder - real value passed during Cloud Run deployment
      EMAIL_HOST_PASSWORD: 'placeholder'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create service-account-credentials.json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: service-account-credentials.json
          json: ${{ secrets.GCP_CREDENTIALS }}

      - uses: 'google-github-actions/auth@v2'
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: URL-encode database credentials for special characters
        env:
          POSTGRES_CREDENTIALS: ${{ secrets.POSTGRES_CREDENTIALS }}
        run: |
          # URL encode credentials to handle special characters like *, !, (, )
          # Extract and encode password securely without exposing it in logs
          ENCODED_CREDENTIALS=$(python3 -c "
          import urllib.parse, os, sys
          try:
              creds = os.environ['POSTGRES_CREDENTIALS']
              if ':' in creds:
                  user, password = creds.split(':', 1)
                  encoded_password = urllib.parse.quote(password, safe='')
                  print(f'{user}:{encoded_password}')
              else:
                  print(creds)
          except Exception:
              sys.exit(1)
          ")
          
          if [ $? -eq 0 ]; then
            echo "ENCODED_DB_CREDENTIALS=$ENCODED_CREDENTIALS" >> $GITHUB_ENV
            echo "Database credentials encoded successfully"
          else
            echo "Failed to encode database credentials"
            exit 1
          fi

      - name: Download and run the Cloud SQL Auth Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.10.1/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy --address 0.0.0.0 --port 1234 ${{ secrets.CLOUD_SQL_ICN }} &

      - name: Run migrations
        env:
          DJ_DATABASE_CONN_STRING: postgres://${{ env.ENCODED_DB_CREDENTIALS }}@localhost:1234/${{ vars.DATABASE_NAME }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        run: python3 manage.py migrate

      - name: Stop Cloud SQL Auth Proxy
        run: pkill cloud-sql-proxy

      - name: Collect static files
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DJ_DATABASE_CONN_STRING: postgres://${{ env.ENCODED_DB_CREDENTIALS }}@localhost:1234/${{ vars.DATABASE_NAME }}
        run: python3 manage.py collectstatic --no-input

      - name: Configure CORS for storage bucket
        env:
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
          DJ_DATABASE_CONN_STRING: postgres://${{ env.ENCODED_DB_CREDENTIALS }}@localhost:1234/${{ vars.DATABASE_NAME }}
        run: |
          python3 manage.py create_gcp_cors_config
          export GS_BUCKET_NAME=$(python3 -c "from django.conf import settings; print(settings.GS_BUCKET_NAME)")
          gcloud storage buckets update gs://$GS_BUCKET_NAME --cors-file=gcp-cors-config.json

      - name: Build and push Docker image
        run: >
          gcloud builds submit
          --region us-central1
          --tag us-central1-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REGISTRY }}/schemaindex:latest
          .

      - name: Deploy to Cloud Run
        run: >
          gcloud run deploy ${{ vars.CLOUD_RUN_SERVICE_NAME }}
          --region us-central1
          --image us-central1-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ vars.ARTIFACT_REGISTRY }}/schemaindex:latest
          --service-account ${{ vars.SERVICE_ACCOUNT_NAME }}
          --add-cloudsql-instances=${{ secrets.CLOUD_SQL_ICN }}
          --set-env-vars DJANGO_SETTINGS_MODULE="${{ vars.DJANGO_SETTINGS_MODULE }}"
          --set-env-vars DJANGO_SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
          --set-env-vars DJ_DATABASE_CONN_STRING="postgres://${{ env.ENCODED_DB_CREDENTIALS }}@//cloudsql/${{ secrets.CLOUD_SQL_ICN }}/${{ vars.DATABASE_NAME }}"
          --set-env-vars EMAIL_HOST_PASSWORD="${{ secrets.EMAIL_HOST_PASSWORD }}"
          --allow-unauthenticated
